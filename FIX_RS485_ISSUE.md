# ×ª×™×§×•×Ÿ ×‘×¢×™×™×ª ×”×ª×§×©×•×¨×ª ×¢× ×”×‘×§×¨ RS485

## ×”×‘×¢×™×”
×”×‘×§×¨ KR-CU16 ×”×™×” ×ž×—×–×™×¨ ×ª×©×•×‘×•×ª ×ž×©×•×‘×©×•×ª ×œ×ž×¨×•×ª ×©×”×ž× ×¢×•×œ×™× × ×¤×ª×—×• ×¤×™×–×™×ª.
×”×©×’×™××•×ª ×©×”×•×¤×™×¢×•:
```
[WARNING] Cart unlock command sent (no response received)
[ERROR] Invalid frame markers: STX=FB, ETX=F2
[ERROR] Invalid frame markers: STX=FF, ETX=FE
```

## ×”×¡×™×‘×”
×”×‘××¤×¨ ×©×œ ×”×ª×§×©×•×¨×ª ×”×¡×“×¨×ª×™×ª (Serial Buffer) ×œ× × ×•×§×” ×œ×¤× ×™ ×›×œ ×¤×§×•×“×”, ×•×œ×›×Ÿ × ×©××¨×• ×©××¨×™×•×ª ×ž×¤×§×•×“×•×ª ×§×•×“×ž×•×ª ×©×’×¨×ž×• ×œ×ª×©×•×‘×•×ª ×ž×©×•×‘×©×•×ª.

## ×”×ª×™×§×•×Ÿ ×©×‘×•×¦×¢
×‘×§×•×‘×¥ `src/hardware/rs485.py` ×‘×¤×•× ×§×¦×™×” `_send_command()` ×”×•×¡×¤× ×•:

1. **× ×™×§×•×™ Buffer ×œ×¤× ×™ ×©×œ×™×—×”:**
   ```python
   self.serial.reset_input_buffer()
   self.serial.reset_output_buffer()
   ```

2. **×”×ž×ª× ×” ×§×¦×¨×” ××—×¨×™ ×©×œ×™×—×”:**
   ```python
   time.sleep(0.1)  # 100ms delay
   ```

3. **××™×ž×•×ª ×§×‘×œ×ª ×ª×©×•×‘×”:**
   ```python
   if not response or len(response) == 0:
       logger.warning("No response received from controller")
       return None
   ```

4. **× ×™×¡×™×•× ×•×ª ×—×•×–×¨×™× ××•×˜×•×ž×˜×™×™× (NEW!):**
   - ×× ×œ× ×”×ª×§×‘×œ×” ×ª×©×•×‘×”, ×”×ž×¢×¨×›×ª ×ž× ×¡×” ×©×•×‘ (×¢×“ 3 ×¤×¢×ž×™×)
   - ×‘×™×Ÿ ×›×œ × ×™×¡×™×•×Ÿ: ×¡×’×™×¨×” ×•×¤×ª×™×—×” ×ž×—×“×© ×©×œ ×”×¤×•×¨×˜
   - ×–×ž×Ÿ ×”×ž×ª× ×” ×’×“×œ ×‘×›×œ × ×™×¡×™×•×Ÿ (0.1s â†’ 0.15s â†’ 0.2s)

5. **×‘×“×™×§×ª Baud Rate ××•×˜×•×ž×˜×™×ª:**
   - ×¤×•× ×§×¦×™×” ×—×“×©×” `test_baudrates()` ×©×‘×•×“×§×ª: 9600, 19200, 38400, 115200
   - ×ž×•×¦××ª ××•×˜×•×ž×˜×™×ª ××ª ×”×§×¦×‘ ×”× ×›×•×Ÿ
   - ×¡×§×¨×™×¤×˜ × ×¤×¨×“: `test_baud_rates.py`

## ×”×•×¨××•×ª ×œ×—×‘×¨

### ×©×œ×‘ 1: ×¢×“×›×•×Ÿ ×”×§×•×“
×¤×©×•×˜ ×”×¢×ª×§ ××ª ×›×œ ×”×ª×™×§×™×™×” `CartWise-Pro` ×”×—×“×©×” ×©×§×™×‘×œ×ª (×›×•×œ×œ ×”×ª×™×§×•×Ÿ).

### ×©×œ×‘ 2: ×‘×“×™×§×ª ×”×—×™×‘×•×¨

#### ×‘-Windows:
1. ×•×•×“× ×©×”×‘×§×¨ ×ž×—×•×‘×¨ ×œ-COM port ×”× ×›×•×Ÿ
2. ×‘×“×•×§ ×‘-`config/.env` ×©×”-port × ×›×•×Ÿ:
   ```env
   SERIAL_PORT=COM4
   BAUD_RATE=19200
   ```

#### ×‘-Linux:
×”×§×•×“ ×¢×›×©×™×• **×ª×•×ž×š ××•×˜×•×ž×˜×™×ª ×‘×œ×™× ×•×§×¡**!

**××•×¤×¦×™×” 1: ×”×©××¨ COM4 (×ž×•×ž×œ×¥)**
```env
SERIAL_PORT=COM4
```
×”×§×•×“ ×™×”×¤×•×š ××ª ×–×” ××•×˜×•×ž×˜×™×ª ×œ-`/dev/ttyCOM4` ×‘×œ×™× ×•×§×¡.

**××•×¤×¦×™×” 2: ×©×™×ž×•×© ×™×©×™×¨ ×‘× ×ª×™×‘ ×œ×™× ×•×§×¡**
```env
SERIAL_PORT=/dev/ttyUSB0
# ××•
SERIAL_PORT=/dev/ttyCOM4
```

**××™×š ×œ×“×¢×ª ××™×–×” ×¤×•×¨×˜?**
```bash
# ×”×¦×’ ××ª ×›×œ ×”×¤×•×¨×˜×™× ×”×–×ž×™× ×™×
ls /dev/tty*

# ××• ×”×©×ª×ž×© ×‘-Python
python3 -c "import serial.tools.list_ports; [print(p.device) for p in serial.tools.list_ports.comports()]"
```

### ×©×œ×‘ 3: ×”×¨×¦×ª ×”×©×¨×ª
```bash
python run_server.py
```

### ×©×œ×‘ 4: ×‘×“×™×§×”
1. ×¤×ª×— http://localhost:8002
2. × ×¡×” ×œ×”×§×¦×•×ª ×¢×’×œ×”
3. ×‘×“×•×§ ×‘×œ×•×’×™× ×©×”×ª×§×©×•×¨×ª ×ª×§×™× ×”:
   ```
   [DEBUG] Buffers cleared
   [DEBUG] >> Sent: 0200310336
   [DEBUG] << Received: 0202350000000003XX
   [INFO] Cart unlocked successfully
   ```

## ×‘×“×™×§×ª COM Port ×‘×ž×—×©×‘ ×©×œ×š

### Windows:
1. ×¤×ª×— Device Manager
2. ×—×¤×© "Ports (COM & LPT)"
3. ×ž×¦× ××ª ×ž×¡×¤×¨ ×”-COM ×©×œ ×”×‘×§×¨
4. ×¢×“×›×Ÿ ×‘-`config/.env`

### Linux:
```bash
# ×¨×©×™×ž×ª ×›×œ ×”×¤×•×¨×˜×™×
ls -l /dev/tty* | grep -E "(USB|ACM|COM)"

# ××• ×”×©×ª×ž×© ×‘-dmesg ×œ×¨××•×ª ×¤×•×¨×˜×™× ×©×–×•×”×• ×œ××—×¨×•× ×”
dmesg | grep tty

# ×‘×“×™×§×ª ×”×¨×©××•×ª
ls -l /dev/ttyUSB0  # ××• /dev/ttyCOM4
```

### ×‘×“×™×§×” ×“×¨×š Python (Windows & Linux):
```python
import serial.tools.list_ports
ports = serial.tools.list_ports.comports()
for port in ports:
    print(f"{port.device}: {port.description}")
```

## ×× ×¢×“×™×™×Ÿ ×™×© ×‘×¢×™×•×ª

### ×‘×¢×™×”: "COM port not found" (Windows)
**×¤×ª×¨×•×Ÿ:** ×‘×“×•×§ ××ª ×ž×¡×¤×¨ ×”-COM port ×‘×”×’×“×¨×•×ª ×”×ž×¢×¨×›×ª ×•×¢×“×›×Ÿ ×‘-`config/.env`

### ×‘×¢×™×”: "Permission denied" (Windows)
**×¤×ª×¨×•×Ÿ:**
- ×¡×’×•×¨ ×ª×•×›× ×™×•×ª ××—×¨×•×ª ×©×ž×©×ª×ž×©×•×ª ×‘-COM port
- ×”×¨×¥ ×›×ž× ×”×œ (Run as Administrator)

### ×‘×¢×™×”: "Permission denied" (Linux)
**×”×‘×¢×™×”:** ×”×ž×©×ª×ž×© ××™× ×• ×‘×¢×œ ×”×¨×©××•×ª ×œ×’×©×ª ×œ×¤×•×¨×˜ ×”×¡×“×¨×ª×™.

**×¤×ª×¨×•×Ÿ:**
```bash
# ×”×•×¡×£ ××ª ×”×ž×©×ª×ž×© ×œ×§×‘×•×¦×ª dialout (×ž××¤×©×¨ ×’×™×©×” ×œ×¤×•×¨×˜×™× ×¡×“×¨×ª×™×™×)
sudo usermod -a -G dialout $USER

# ××• ×œ×§×‘×•×¦×ª uucp (×‘×—×œ×§ ×ž×”×”×¤×¦×•×ª)
sudo usermod -a -G uucp $USER

# ×™×© ×œ×”×ª× ×ª×§ ×•×œ×”×ª×—×‘×¨ ×ž×—×“×© ×›×“×™ ×©×”×©×™× ×•×™ ×™×™×›× ×¡ ×œ×ª×•×§×£
# ××• ×× ××ª×” ×¨×•×¦×” ×©×–×” ×™×§×¨×” ×ž×™×“ (×œ×œ× ×”×ª× ×ª×§×•×ª):
newgrp dialout

# ×‘×“×™×§×” ×©×”×”×¨×©××•×ª ×ª×§×™× ×•×ª:
groups  # ×¦×¨×™×š ×œ×”×¨××•×ª dialout ××• uucp
```

### ×‘×¢×™×”: "No such file or directory: '/dev/ttyCOM4'" (Linux)
**×”×‘×¢×™×”:** ×”×¤×•×¨×˜ ×œ× ×§×™×™× ×‘×ž×¢×¨×›×ª.

**×¤×ª×¨×•×Ÿ:**
1. ×‘×“×•×§ ××™×–×” ×¤×•×¨×˜ ×§×™×™× ×‘×¤×•×¢×œ:
   ```bash
   ls -l /dev/tty* | grep -E "(USB|ACM)"
   ```

2. ×¢×“×›×Ÿ ××ª `config/.env` ×œ×¤×•×¨×˜ ×”× ×›×•×Ÿ:
   ```env
   SERIAL_PORT=/dev/ttyUSB0
   # ××•
   SERIAL_PORT=/dev/ttyACM0
   ```

3. ×× ××ª×” ×ž×©×ª×ž×© ×‘-udev rules ×›×“×™ ×œ×™×¦×•×¨ `/dev/ttyCOM4`, ×•×•×“× ×©×”-rule ×¤×•×¢×œ:
   ```bash
   # ×”×¦×’ ××ª ×”-rules
   cat /etc/udev/rules.d/99-usb-serial.rules

   # ×˜×¢×Ÿ ×ž×—×“×© ××ª ×”-udev rules
   sudo udevadm control --reload-rules
   sudo udevadm trigger
   ```

### ×‘×¢×™×”: ×¢×“×™×™×Ÿ ×ž×§×‘×œ ×ª×©×•×‘×•×ª ×ž×©×•×‘×©×•×ª
**×¤×ª×¨×•×Ÿ:**
1. × ×¡×” ×œ×”×’×“×™×œ ××ª ×–×ž×Ÿ ×”×”×ž×ª× ×” ×‘-`rs485.py` ×ž-0.1 ×œ-0.2:
   ```python
   time.sleep(0.2)
   ```
2. ×‘×“×•×§ ××ª ×”×›×‘×œ - ××•×¨×š ×ž×§×¡×™×ž×œ×™ 1200 ×ž×˜×¨
3. ×”×¨×—×§ ×”×›×‘×œ ×ž×ž×§×•×¨×•×ª ×”×¤×¨×¢×” ×—×©×ž×œ×™×•×ª

### ×‘×¢×™×”: Baud rate ×œ× × ×›×•×Ÿ
**××‘×—×•×Ÿ ××•×˜×•×ž×˜×™:**
```bash
python test_baud_rates.py COM4
```
×”×¡×§×¨×™×¤×˜ ×™×‘×“×•×§ ××ª ×›×œ ×”×§×¦×‘×™× ×”× ×¤×•×¦×™× ×•×™×’×™×“ ×œ×š ×ž×” ×¢×•×‘×“!

**×¤×ª×¨×•×Ÿ ×™×“× ×™:** × ×¡×” baud rates ×©×•× ×™×:
- 9600
- 19200 (×‘×¨×™×¨×ª ×ž×—×“×œ)
- 38400
- 115200

### ×‘×¢×™×”: ×”×‘×§×¨ ×œ× ×ž×—×–×™×¨ ×ª×©×•×‘×” ×‘×›×œ×œ
**×ž×” ×§×•×¨×”:**
```
[WARNING] No response received from controller (attempt 1/3)
[INFO] Resetting port before retry...
[WARNING] No response received from controller (attempt 2/3)
[ERROR] All retry attempts failed - controller not responding
```

**×¤×ª×¨×•×Ÿ:**
1. **×‘×“×•×§ ×—×™×•×•×˜ ×¤×™×–×™:**
   - RS485 A â†’ A
   - RS485 B â†’ B
   - GND â†’ GND
   - ××•×œ×™ ×”× ×”×¤×•×›×™×? × ×¡×” ×œ×”×—×œ×™×£ A ×¢× B

2. **×‘×“×•×§ ×ž×ª×—:**
   - ×”×‘×§×¨ ×¦×¨×™×š 12V DC
   - ×‘×“×•×§ ×¢× ×ž×•×œ×˜×™×ž×˜×¨

3. **×‘×“×•×§ ×¢× ×¡×§×¨×™×¤×˜ ×”××‘×—×•×Ÿ:**
   ```bash
   python test_baud_rates.py COM4
   ```
   ×”×•× ×™×‘×“×•×§ ××ª ×›×œ ×”××¤×©×¨×•×™×•×ª ×•×™×’×™×“ ×œ×š ×ž×” ×”×‘×¢×™×”

4. **× ×¡×” ×¢× ×¤×•×¨×˜ ××—×¨:**
   ```bash
   # ×‘×“×•×§ ××™×–×” ×¤×•×¨×˜×™× ×™×© ×œ×š
   python -c "import serial.tools.list_ports; [print(p.device) for p in serial.tools.list_ports.comports()]"
   ```

## ×§×‘×¦×™× ×©×”×©×ª× ×•
- `src/hardware/rs485.py` - ×”×ª×™×§×•×Ÿ ×”×¢×™×§×¨×™
- ×”×§×•×‘×¥ ×”×–×” (FIX_RS485_ISSUE.md) - ×”×ª×™×¢×•×“

## ×™×¦×™×¨×ª ×§×©×¨
×× ×™×© ×‘×¢×™×•×ª, ×‘×“×•×§ ××ª ×”×œ×•×’×™× ×‘-`logs/cartwise.log` ×•×©×œ×— ×œ×™ ××ª ×”×©×•×¨×•×ª ×”×¨×œ×•×•× ×˜×™×•×ª.

×‘×”×¦×œ×—×”! ðŸŽ‰
